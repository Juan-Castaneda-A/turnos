<!-- templates/funcionario_panel.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notaría Tercera - Panel de Atención</title>
    <!-- Carga de Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Fondo oscuro */
            color: #e2e8f0; /* Texto claro */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Evita scroll horizontal */
        }
        .container {
            max-width: 1400px; /* Ancho máximo para el panel */
            margin: 0 auto;
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .panel-section {
            background-color: #2d3748; /* Fondo de las secciones */
            border-radius: 1.5rem; /* Bordes redondeados */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }
        .section-title {
            font-size: 1.75rem; /* Título de sección */
            font-weight: 700;
            color: #48bb78; /* Verde brillante */
            margin-bottom: 1.5rem;
            text-shadow: 0 0 8px rgba(72, 187, 120, 0.3);
        }
        .table-header {
            background-color: #4a5568; /* Fondo para encabezados de tabla */
            color: #e2e8f0;
            font-weight: 600;
        }
        .table-row:nth-child(even) {
            background-color: #2d3748; /* Fondo alterno para filas */
        }
        .table-row:nth-child(odd) {
            background-color: #2c3546;
        }
        .table-row td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #4a5568;
            font-size: 1rem;
        }
        .table-row:last-child td {
            border-bottom: none;
        }
        .action-button {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px -3px rgba(0, 0, 0, 0.2);
        }
        .btn-call {
            background-color: #4299e1; /* Azul */
            color: white;
        }
        .btn-call:hover:enabled {
            background-color: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -5px rgba(66, 153, 225, 0.6);
        }
        .btn-recall {
            background-color: #ecc94b; /* Amarillo */
            color: #2d3748;
        }
        .btn-recall:hover:enabled {
            background-color: #d69e2e;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -5px rgba(236, 201, 75, 0.6);
        }
        .btn-finish {
            background-color: #48bb78; /* Verde */
            color: white;
        }
        .btn-finish:hover:enabled {
            background-color: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -5px rgba(72, 187, 120, 0.6);
        }
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Responsive adjustments */
        @media (min-width: 1024px) { /* Desktop layout */
            .main-grid {
                grid-template-columns: 1fr 2fr 1fr; /* 3 columnas: Turnos, Mi Módulo, Historial */
            }
        }
        @media (max-width: 1023px) { /* Tablet and Mobile layout */
            .main-grid {
                grid-template-columns: 1fr; /* Una columna */
            }
            .panel-section {
                margin-bottom: 1.5rem; /* Espacio entre secciones apiladas */
            }
        }
    </style>
</head>
<body>
    <div class="container flex flex-col p-4 space-y-6">
        <!-- Encabezado del Panel -->
        <header class="flex flex-col md:flex-row justify-between items-center py-4 px-6 bg-blue-800 rounded-xl shadow-lg mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight mb-2 md:mb-0">
                Panel de Atención Notaría Tercera
            </h1>
            <div class="text-xl md:text-2xl font-semibold text-blue-200">
                Bienvenido, <span class="text-white">{{ user_name }}</span> | Módulo: <span class="text-white" id="assigned-module-name">Cargando...</span>
            </div>
            <a href="{{ url_for('logout') }}" class="mt-4 md:mt-0 px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition duration-300">
                Cerrar Sesión
            </a>
        </header>

        <main class="main-grid grid gap-6 flex-grow">
            <!-- Sección 1: Turnos por Atender -->
            <section class="panel-section col-span-1">
                <h2 class="section-title">Turnos por Atender</h2>
                <div class="overflow-y-auto max-h-[calc(100vh-250px)] custom-scrollbar">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="table-header">
                                <th class="px-4 py-2 rounded-tl-lg">Turno</th>
                                <th class="px-4 py-2 rounded-tr-lg">Servicio</th>
                            </tr>
                        </thead>
                        <tbody id="pending-turns-body">
                            <!-- Los turnos pendientes se cargarán aquí por JavaScript -->
                            <tr>
                                <td colspan="2" class="text-center text-gray-500 py-4">Cargando turnos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Sección 2: Mi Módulo [N] -->
            <section class="panel-section col-span-2 flex flex-col items-center justify-center text-center">
                <h2 class="section-title" id="my-module-title">Mi Módulo: Cargando...</h2>
                <div class="flex-grow flex flex-col justify-center items-center w-full">
                    <p class="text-xl font-medium text-gray-400 mb-4">Turno en Curso:</p>
                    <div id="current-attending-turn" class="text-7xl font-extrabold text-yellow-400 mb-4 tracking-wide">---</div>
                    <p id="current-attending-service" class="text-3xl font-semibold text-gray-300 mb-8">Esperando nuevo turno...</p>

                    <div class="flex flex-col sm:flex-row gap-4 w-full justify-center">
                        <button id="btn-call-next" class="action-button btn-call flex-1" disabled>
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            Llamar Siguiente
                        </button>
                        <button id="btn-recall" class="action-button btn-recall flex-1" disabled>
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17l-3 3m0 0l-3-3m3 3V3"></path></svg>
                            Rellamar
                        </button>
                        <button id="btn-finish" class="action-button btn-finish flex-1" disabled>
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Finalizar Turno
                        </button>
                    </div>
                </div>
            </section>

            <!-- Sección 3: Historial del Día -->
            <section class="panel-section col-span-1">
                <h2 class="section-title">Historial del Día</h2>
                <div class="overflow-y-auto max-h-[calc(100vh-250px)] custom-scrollbar">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="table-header">
                                <th class="px-4 py-2 rounded-tl-lg">Turno</th>
                                <th class="px-4 py-2 rounded-tr-lg">Hora Fin</th>
                            </tr>
                        </thead>
                        <tbody id="daily-history-body">
                            <!-- El historial del día se cargará aquí por JavaScript -->
                            <tr>
                                <td colspan="2" class="text-center text-gray-500 py-4">Cargando historial...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para Confirmación (reemplazo de alert/confirm) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 class="text-2xl font-bold text-white mb-4" id="modal-title"></h3>
            <p class="text-gray-300 mb-6" id="modal-message"></p>
            <div class="flex justify-center gap-4">
                <button id="modal-confirm-btn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg">Confirmar</button>
                <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar el cliente de Supabase
        // Usando cdn.jsdelivr.net para una importación más estable del paquete ESM
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/+esm';

        // Variables de configuración (pasadas desde Flask)
        const SUPABASE_URL = "{{ supabase_url }}";
        const SUPABASE_KEY = "{{ supabase_key }}";
        // Convertir la cadena 'None' o 'null' a null de JavaScript
        const USER_ID = "{{ session['user_id'] }}" === 'None' || "{{ session['user_id'] }}" === 'null' ? null : "{{ session['user_id'] }}";
        const ASSIGNED_MODULE_ID_STR = "{{ session['assigned_module_id'] }}";
        const ASSIGNED_MODULE_ID = ASSIGNED_MODULE_ID_STR === 'None' || ASSIGNED_MODULE_ID_STR === 'null' ? null : parseInt(ASSIGNED_MODULE_ID_STR);
        const USER_NAME = "{{ user_name }}"; // Nombre del usuario

        // Inicializar Supabase
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log("Supabase Client inicializado para Panel de Funcionario.");
        console.log("Objeto Supabase:", supabase); // DEBUG: Inspeccionar el objeto supabase
        console.log("¿Existe supabase.from?", typeof supabase.from); // DEBUG: Verificar si .from existe

        // DEBUG: Inspeccionar el objeto retornado por supabase.from()
        let testFromObject;
        try {
            testFromObject = supabase.from('turnos');
            console.log("Objeto retornado por supabase.from('turnos'):", testFromObject);
            console.log("¿Existe testFromObject.on?", typeof testFromObject.on); // ESTO DEBERÍA SER 'function'
        } catch (e) {
            console.error("Error al intentar llamar supabase.from('turnos'):", e);
        }


        // Referencias a elementos del DOM
        const assignedModuleNameElement = document.getElementById('assigned-module-name');
        const myModuleTitleElement = document.getElementById('my-module-title');
        const pendingTurnsBody = document.getElementById('pending-turns-body');
        const currentAttendingTurnElement = document.getElementById('current-attending-turn');
        const currentAttendingServiceElement = document.getElementById('current-attending-service');
        const btnCallNext = document.getElementById('btn-call-next');
        const btnRecall = document.getElementById('btn-recall');
        const btnFinish = document.getElementById('btn-finish');
        const dailyHistoryBody = document.getElementById('daily-history-body');

        // Modal de Confirmación
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        let currentAttendingTurnId = null; // ID del turno que el funcionario está atendiendo actualmente

        // --- Funciones de Utilidad ---

        // Función para mostrar el modal de confirmación
        function showConfirmationModal(title, message) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmationModal.classList.remove('hidden');

                const handleConfirm = () => {
                    confirmationModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    confirmationModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                modalConfirmBtn.addEventListener('click', handleConfirm);
                modalCancelBtn.addEventListener('click', handleCancel);
            });
        }

        // --- Funciones de Actualización de UI ---

        async function updateAssignedModuleName() {
            if (ASSIGNED_MODULE_ID !== null) {
                try {
                    const { data, error } = await supabase
                        .from('modulos')
                        .select('nombre_modulo')
                        .eq('id_modulo', ASSIGNED_MODULE_ID)
                        .single();
                    if (error) throw error;
                    assignedModuleNameElement.textContent = data.nombre_modulo;
                    myModuleTitleElement.textContent = `Mi Módulo: ${data.nombre_modulo}`;
                } catch (error) {
                    console.error("Error al obtener nombre del módulo:", error.message);
                    assignedModuleNameElement.textContent = 'Error';
                    myModuleTitleElement.textContent = 'Mi Módulo: Error';
                }
            } else {
                assignedModuleNameElement.textContent = 'No Asignado';
                myModuleTitleElement.textContent = 'Mi Módulo: No Asignado';
                btnCallNext.disabled = true;
                btnRecall.disabled = true;
                btnFinish.disabled = true;
            }
        }

        async function loadPendingTurns() {
            pendingTurnsBody.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 py-4">Cargando turnos...</td></tr>`;
            if (ASSIGNED_MODULE_ID === null) {
                pendingTurnsBody.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 py-4">Asigne un módulo a este funcionario para ver turnos.</td></tr>`;
                btnCallNext.disabled = true;
                return;
            }

            try {
                const { data: moduleServices, error: msError } = await supabase
                    .from('modulos_servicios')
                    .select('id_servicio')
                    .eq('id_modulo', ASSIGNED_MODULE_ID);
                if (msError) throw msError;

                const serviceIds = moduleServices.map(ms => ms.id_servicio);

                if (serviceIds.length === 0) {
                    pendingTurnsBody.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 py-4">Este módulo no tiene servicios configurados.</td></tr>`;
                    btnCallNext.disabled = true;
                    return;
                }

                const { data: turns, error: turnsError } = await supabase
                    .from('turnos')
                    .select('*, servicios(nombre_servicio)')
                    .eq('estado', 'en espera')
                    .in('id_servicio', serviceIds)
                    .order('hora_solicitud', { ascending: true });

                if (turnsError) throw turnsError;

                pendingTurnsBody.innerHTML = '';
                if (turns.length === 0) {
                    pendingTurnsBody.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 py-4">No hay turnos pendientes.</td></tr>`;
                    btnCallNext.disabled = true;
                } else {
                    turns.forEach(turn => {
                        const tr = document.createElement('tr');
                        tr.className = 'table-row';
                        tr.innerHTML = `
                            <td class="px-4 py-2">${turn.prefijo_turno}-${String(turn.numero_turno).padStart(3, '0')}</td>
                            <td class="px-4 py-2">${turn.servicios.nombre_servicio}</td>
                        `;
                        pendingTurnsBody.appendChild(tr);
                    });
                    btnCallNext.disabled = false;
                }
            } catch (error) {
                console.error("Error al cargar turnos pendientes:", error.message);
                pendingTurnsBody.innerHTML = `<tr><td colspan="2" class="text-center text-red-400 py-4">Error al cargar turnos.</td></tr>`;
                btnCallNext.disabled = true;
            }
            updateButtonStates();
        }

        async function loadCurrentTurn() {
            if (ASSIGNED_MODULE_ID === null) {
                currentAttendingTurnElement.textContent = '---';
                currentAttendingServiceElement.textContent = 'Módulo no asignado.';
                currentAttendingTurnId = null;
                updateButtonStates();
                return;
            }

            try {
                const { data: turn, error } = await supabase
                    .from('turnos')
                    .select('*, servicios(nombre_servicio)')
                    .eq('estado', 'en atencion')
                    .eq('id_modulo_atencion', ASSIGNED_MODULE_ID)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (turn) {
                    currentAttendingTurnElement.textContent = `${turn.prefijo_turno}-${String(turn.numero_turno).padStart(3, '0')}`;
                    currentAttendingServiceElement.textContent = turn.servicios.nombre_servicio;
                    currentAttendingTurnId = turn.id_turno;
                } else {
                    currentAttendingTurnElement.textContent = '---';
                    currentAttendingServiceElement.textContent = 'Esperando nuevo turno...';
                    currentAttendingTurnId = null;
                }
            } catch (error) {
                console.error("Error al cargar turno actual:", error.message);
                currentAttendingTurnElement.textContent = 'Error';
                currentAttendingServiceElement.textContent = 'Error al cargar turno.';
                currentAttendingTurnId = null;
            }
            updateButtonStates();
        }

        async function loadDailyHistory() {
            dailyHistoryBody.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 py-4">Cargando historial...</td></tr>`;
            if (ASSIGNED_MODULE_ID === null) {
                dailyHistoryBody.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 py-4">Asigne un módulo a este funcionario para ver historial.</td></tr>`;
                return;
            }

            try {
                const today = new Date().toISOString().split('T')[0];
                const { data: history, error } = await supabase
                    .from('turnos')
                    .select('*')
                    .eq('estado', 'atendido')
                    .eq('id_modulo_atencion', ASSIGNED_MODULE_ID)
                    .gte('hora_finalizacion', today)
                    .order('hora_finalizacion', { ascending: false });

                if (error) throw error;

                dailyHistoryBody.innerHTML = '';
                if (history.length === 0) {
                    dailyHistoryBody.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 py-4">No hay turnos atendidos hoy.</td></tr>`;
                } else {
                    history.forEach(turn => {
                        const tr = document.createElement('tr');
                        tr.className = 'table-row';
                        const finalizationTime = new Date(turn.hora_finalizacion).toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
                        tr.innerHTML = `
                            <td class="px-4 py-2">${turn.prefijo_turno}-${String(turn.numero_turno).padStart(3, '0')}</td>
                            <td class="px-4 py-2">${finalizationTime}</td>
                        `;
                        dailyHistoryBody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error("Error al cargar historial diario:", error.message);
                dailyHistoryBody.innerHTML = `<tr><td colspan="2" class="text-center text-red-400 py-4">Error al cargar historial.</td></tr>`;
            }
        }

        function updateButtonStates() {
            if (ASSIGNED_MODULE_ID === null) {
                btnCallNext.disabled = true;
                btnRecall.disabled = true;
                btnFinish.disabled = true;
                return;
            }

            const hasCurrentTurn = currentAttendingTurnId !== null;
            const hasPendingTurns = pendingTurnsBody.querySelector('.table-row') !== null &&
                                    pendingTurnsBody.querySelector('.text-gray-500') === null &&
                                    pendingTurnsBody.querySelector('.text-red-400') === null;

            btnCallNext.disabled = hasCurrentTurn || !hasPendingTurns;
            btnRecall.disabled = !hasCurrentTurn;
            btnFinish.disabled = !hasCurrentTurn;
        }

        // --- Manejo de Acciones de Turno ---

        btnCallNext.addEventListener('click', async () => {
            const confirmed = await showConfirmationModal('Llamar Siguiente Turno', '¿Está seguro de que desea llamar al siguiente turno disponible?');
            if (!confirmed) return;

            btnCallNext.disabled = true;
            try {
                const { data: moduleServices, error: msError } = await supabase
                    .from('modulos_servicios')
                    .select('id_servicio')
                    .eq('id_modulo', ASSIGNED_MODULE_ID);
                if (msError) throw msError;
                const serviceIds = moduleServices.map(ms => ms.id_servicio);

                const { data: nextTurn, error: nextTurnError } = await supabase
                    .from('turnos')
                    .select('id_turno, prefijo_turno, numero_turno')
                    .eq('estado', 'en espera')
                    .in('id_servicio', serviceIds)
                    .order('hora_solicitud', { ascending: true })
                    .limit(1)
                    .single();

                if (nextTurnError && nextTurnError.code !== 'PGRST116') {
                    throw nextTurnError;
                }
                if (!nextTurn) {
                    await showConfirmationModal('Atención', 'No hay turnos pendientes para llamar.');
                    return;
                }

                const { error: updateError } = await supabase
                    .from('turnos')
                    .update({
                        estado: 'en atencion',
                        hora_llamado: new Date().toISOString(),
                        id_modulo_atencion: ASSIGNED_MODULE_ID
                    })
                    .eq('id_turno', nextTurn.id_turno);

                if (updateError) throw updateError;

                await supabase.from('logs_turnos').insert({
                    id_turno: nextTurn.id_turno,
                    id_usuario: USER_ID,
                    accion: 'llamado'
                });

                console.log(`Turno ${nextTurn.prefijo_turno}-${nextTurn.numero_turno} llamado.`);
            } catch (error) {
                console.error("Error al llamar siguiente turno:", error.message);
                await showConfirmationModal('Error', `Error al llamar turno: ${error.message}`);
            } finally {
                updateButtonStates();
            }
        });

        btnRecall.addEventListener('click', async () => {
            if (!currentAttendingTurnId) {
                await showConfirmationModal('Atención', 'No hay un turno en curso para rellamar.');
                return;
            }
            const confirmed = await showConfirmationModal('Rellamar Turno', '¿Está seguro de que desea rellamar el turno actual?');
            if (!confirmed) return;

            btnRecall.disabled = true;
            try {
                const { error: updateError } = await supabase
                    .from('turnos')
                    .update({ hora_llamado: new Date().toISOString() })
                    .eq('id_turno', currentAttendingTurnId);

                if (updateError) throw updateError;

                await supabase.from('logs_turnos').insert({
                    id_turno: currentAttendingTurnId,
                    id_usuario: USER_ID,
                    accion: 'rellamado'
                });

                console.log(`Turno ${currentAttendingTurnId} rellamado.`);
            } catch (error) {
                console.error("Error al rellamar turno:", error.message);
                await showConfirmationModal('Error', `Error al rellamar turno: ${error.message}`);
            } finally {
                btnRecall.disabled = false;
                updateButtonStates();
            }
        });

        btnFinish.addEventListener('click', async () => {
            if (!currentAttendingTurnId) {
                await showConfirmationModal('Atención', 'No hay un turno en curso para finalizar.');
                return;
            }
            const confirmed = await showConfirmationModal('Finalizar Turno', '¿Está seguro de que desea finalizar el turno actual?');
            if (!confirmed) return;

            btnFinish.disabled = true;
            try {
                const { error: updateError } = await supabase
                    .from('turnos')
                    .update({
                        estado: 'atendido',
                        hora_finalizacion: new Date().toISOString()
                    })
                    .eq('id_turno', currentAttendingTurnId);

                if (updateError) throw updateError;

                await supabase.from('logs_turnos').insert({
                    id_turno: currentAttendingTurnId,
                    id_usuario: USER_ID,
                    accion: 'finalizado'
                });

                console.log(`Turno ${currentAttendingTurnId} finalizado.`);
                currentAttendingTurnId = null;
            } catch (error) {
                console.error("Error al finalizar turno:", error.message);
                await showConfirmationModal('Error', `Error al finalizar turno: ${error.message}`);
            } finally {
                updateButtonStates();
            }
        });


        // --- Suscripciones en tiempo real a Supabase ---

        function setupRealtimeSubscriptions() {
            // Verifica que supabase.from().on exista antes de suscribirse
            if (supabase.from('turnos') && typeof supabase.from('turnos').on === 'function') {
                supabase
                    .from('turnos')
                    .on('*', payload => {
                        console.log('Cambio en turnos recibido en panel funcionario!', payload);
                        loadPendingTurns();
                        loadCurrentTurn();
                        loadDailyHistory();
                    })
                    .subscribe();
            } else {
                console.error("Error: supabase.from('turnos').on no es una función. Las suscripciones en tiempo real no funcionarán.");
            }

            if (supabase.from('modulos_servicios') && typeof supabase.from('modulos_servicios').on === 'function') {
                supabase
                    .from('modulos_servicios')
                    .on('*', payload => {
                        console.log('Cambio en modulos_servicios recibido!', payload);
                        loadPendingTurns();
                    })
                    .subscribe();
            } else {
                console.warn("Advertencia: supabase.from('modulos_servicios').on no es una función. Los cambios de configuración de servicios no se actualizarán en tiempo real.");
            }

            if (supabase.from('modulos') && typeof supabase.from('modulos').on === 'function') {
                supabase
                    .from('modulos')
                    .on('*', payload => {
                        console.log('Cambio en modulos recibido!', payload);
                        updateAssignedModuleName();
                    })
                    .subscribe();
            } else {
                console.warn("Advertencia: supabase.from('modulos').on no es una función. Los cambios de módulos no se actualizarán en tiempo real.");
            }
        }


        // Cargar datos iniciales al cargar la página
        window.onload = () => {
            updateAssignedModuleName();
            loadPendingTurns();
            loadCurrentTurn();
            loadDailyHistory();
            // Retrasar la configuración de las suscripciones en tiempo real
            // para dar tiempo a que el DOM y el cliente de Supabase se inicialicen completamente.
            setTimeout(setupRealtimeSubscriptions, 500); // Retraso de 500ms
        };

    </script>
</body>
</html>
