<!-- templates/visualizador.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notar√≠a Tercera - Turnos en Atenci√≥n</title>
    <!-- Carga de Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Fondo oscuro para alto contraste */
            color: #e2e8f0; /* Texto claro */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden; /* Evita scrollbars no deseados */
        }
        .container {
            max-width: 1280px; /* Ancho m√°ximo para pantallas grandes */
            margin: 0 auto;
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .main-display {
            background-color: #2d3748; /* Fondo m√°s oscuro para el turno actual */
            border-radius: 1.5rem; /* Bordes m√°s redondeados */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            min-height: 250px; /* Altura m√≠nima para el display principal */
            text-align: center;
            animation: fadeIn 1s ease-out; /* Animaci√≥n de entrada */
        }
        .turn-number {
            font-size: 8rem; /* Tama√±o de fuente muy grande para el n√∫mero de turno */
            font-weight: 700;
            color: #48bb78; /* Verde brillante para el n√∫mero */
            line-height: 1;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 15px rgba(72, 187, 120, 0.6); /* Sombra para resaltar */
        }
        .module-direction {
            font-size: 3rem; /* Tama√±o de fuente grande para la direcci√≥n del m√≥dulo */
            font-weight: 600;
            color: #a0aec0; /* Gris claro */
        }
        .history-list {
            background-color: #2d3748;
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            min-height: 200px;
            overflow: hidden; /* Oculta el desbordamiento si hay muchos turnos */
        }
        .history-item {
            font-size: 1.8rem;
            font-weight: 600;
            color: #cbd5e0;
            padding: 0.5rem 0;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .modules-table {
            background-color: #2d3748;
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow-x: auto; /* Permite scroll horizontal en m√≥viles si es necesario */
        }
        .modules-table th, .modules-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 1.25rem;
            white-space: nowrap; /* Evita que el texto se rompa */
        }
        .modules-table th {
            color: #a0aec0;
            font-weight: 700;
            border-bottom: 2px solid #4a5568;
        }
        .modules-table td {
            color: #e2e8f0;
            border-bottom: 1px solid #4a5568;
        }
        .modules-table tr:last-child td {
            border-bottom: none;
        }
        .status-available {
            color: #48bb78; /* Verde para disponible */
            font-weight: 600;
        }
        .status-attending {
            color: #ecc94b; /* Amarillo para atendiendo */
            font-weight: 600;
        }
        .status-inactive {
            color: #e53e3e; /* Rojo para inactivo */
            font-weight: 600;
        }

        /* Animaci√≥n para el turno actual */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulseGreen {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }
        .pulse-animation {
            animation: pulseGreen 1.5s infinite;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .turn-number {
                font-size: 5rem;
            }
            .module-direction {
                font-size: 2rem;
            }
            .history-item {
                font-size: 1.4rem;
            }
            .modules-table th, .modules-table td {
                font-size: 1rem;
            }
            .grid-cols-3 {
                grid-template-columns: 1fr; /* Una columna en pantallas peque√±as */
            }
            .col-span-2 {
                grid-column: span 1 / span 1;
            }
        }
    </style>
</head>
<body>
    <div class="container flex flex-col p-4 space-y-6">
        <!-- Encabezado -->
        <header class="text-center py-6 bg-blue-800 rounded-xl shadow-lg">
            <h1 class="text-5xl font-extrabold text-white tracking-tight">
                <span class="inline-block mr-4">üèõÔ∏è</span> Notar√≠a Tercera de Valledupar
            </h1>
            <h2 class="text-3xl font-semibold text-blue-200 mt-2">Turnos en Atenci√≥n</h2>
        </header>

        <main class="grid grid-cols-3 gap-6 flex-grow">
            <!-- √Årea del Turno Actual -->
            <section class="col-span-2 main-display" id="current-turn-display">
                <p class="text-xl font-medium text-gray-400 mb-2">TURNO ACTUAL:</p>
                <div id="current-turn-number" class="turn-number">---</div>
                <p id="current-turn-module" class="module-direction">Dir√≠jase a la Ventanilla ---</p>
            </section>

            <!-- Historial de Llamados -->
            <section class="col-span-1 history-list">
                <h3 class="text-2xl font-bold text-gray-300 mb-4">√öltimos Llamados</h3>
                <div id="call-history" class="space-y-2">
                    <!-- Los turnos se insertar√°n aqu√≠ por JavaScript -->
                    <div class="history-item text-gray-500">
                        <span>Sin turnos previos</span>
                    </div>
                </div>
            </section>

            <!-- Tabla de Ventanillas -->
            <section class="col-span-3 modules-table">
                <h3 class="text-2xl font-bold text-gray-300 mb-4">Estado de Ventanillas</h3>
                <table class="min-w-full table-auto">
                    <thead>
                        <tr>
                            <th>M√≥dulo</th>
                            <th>Funcionario</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="modules-status-body">
                        <tr>
                            <td colspan="3" class="text-center text-gray-500">Cargando estado de m√≥dulos...</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <!-- Elemento de audio para la alerta de sonido -->
    <!--<audio id="call-sound" src="https://www.soundjay.com/buttons/beep-07.mp3" preload="auto"></audio>-->

    <script type="module">
        // Importar el cliente de Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/+esm';

        // Variables de configuraci√≥n (pasadas desde Flask)
        const SUPABASE_URL = "{{ supabase_url }}";
        const SUPABASE_KEY = "{{ supabase_key }}";

        // Inicializar Supabase
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log("Supabase Client inicializado para Visualizador.");
        console.log("Objeto Supabase:", supabase); // DEBUG: Inspeccionar el objeto supabase
        console.log("¬øExiste supabase.from?", typeof supabase.from); // DEBUG: Verificar si .from existe

        // Referencias a los elementos del DOM
        const currentTurnNumberElement = document.getElementById('current-turn-number');
        const currentTurnModuleElement = document.getElementById('current-turn-module');
        const currentTurnDisplayElement = document.getElementById('current-turn-display');
        const callHistoryElement = document.getElementById('call-history');
        const modulesStatusBodyElement = document.getElementById('modules-status-body');
        //const callSound = document.getElementById('call-sound');

        let lastCalledTurnId = null; // Para evitar reproducir el sonido m√∫ltiples veces para el mismo turno

        //let audioEnabled = false;

        /*document.addEventListener('click', () => {
            audioEnabled = true;
            // Intentar reproducir el sonido para "desbloquear" el audio
            callSound.play().then(() => callSound.pause()).catch(e => console.log(e));
        }, { once: true });*/

        // --- Funciones de Utilidad para Audio y TTS ---

        // Utility function to convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Utility function to convert PCM (Int16Array) to WAV Blob
        function pcmToWav(pcm, sampleRate) {
            const pcmLength = pcm.length;
            const buffer = new ArrayBuffer(44 + pcmLength * 2); // 44 bytes for WAV header, 2 bytes per sample (PCM16)
            const view = new DataView(buffer);

            // WAV header
            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmLength * 2, true); // ChunkSize
            writeString(view, 8, 'WAVE');
            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, 1, true); // NumChannels (1 for mono)
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * 2, true); // ByteRate (SampleRate * NumChannels * BitsPerSample/8)
            view.setUint16(32, 2, true); // BlockAlign (NumChannels * BitsPerSample/8)
            view.setUint16(34, 16, true); // BitsPerSample
            // DATA sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcmLength * 2, true); // Subchunk2Size (NumSamples * NumChannels * BitsPerSample/8)

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcmLength; i++, offset += 2) {
                view.setInt16(offset, pcm[i], true);
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Utility function for exponential backoff with fetch
        async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) { // Too Many Requests
                        console.warn(`Rate limit hit, retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Fetch failed, retrying in ${delay / 1000}s...`, error);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        // Function to convert numbers to Spanish words (simplified for turn numbers)
        function numberToWordsSpanish(num) {
            if (num === 0) return "cero";
            if (num < 0) return "menos " + numberToWordsSpanish(Math.abs(num));

            const units = ["", "uno", "dos", "tres", "cuatro", "cinco", "seis", "siete", "ocho", "nueve"];
            const teens = ["diez", "once", "doce", "trece", "catorce", "quince", "diecis√©is", "diecisiete", "dieciocho", "diecinueve"];
            const tens = ["", "diez", "veinte", "treinta", "cuarenta", "cincuenta", "sesenta", "setenta", "ochenta", "noventa"];
            const specialTeens = {
                21: "veintiuno", 22: "veintid√≥s", 23: "veintitr√©s", 24: "veinticuatro", 25: "veinticinco",
                26: "veintis√©is", 27: "veintisiete", 28: "veintiocho", 29: "veintinueve"
            };

            let words = [];
            let currentNum = num;

            if (currentNum >= 100) {
                const hundredsVal = Math.floor(currentNum / 100);
                if (hundredsVal === 1 && currentNum % 100 === 0) {
                    words.push("cien");
                } else {
                    words.push(units[hundredsVal] === "uno" ? "ciento" : (units[hundredsVal] + "cientos"));
                }
                currentNum %= 100;
            }

            if (currentNum in specialTeens) {
                words.push(specialTeens[currentNum]);
            } else if (currentNum >= 20) {
                words.push(tens[Math.floor(currentNum / 10)]);
                if (currentNum % 10 !== 0) {
                    words.push("y", units[currentNum % 10]);
                }
            } else if (currentNum >= 10) {
                words.push(teens[currentNum - 10]);
            } else if (currentNum > 0) {
                words.push(units[currentNum]);
            }

            return words.join(" ").trim();
        }

        // Function to announce the turn using TTS
        async function announceTurn(prefijoTurno, numeroTurno, nombreModulo) {
            try {
                const numeroTurnoEnPalabras = numberToWordsSpanish(parseInt(numeroTurno, 10));
                const moduleNumberStr = nombreModulo.split(' ')[1]; // Extract "01" from "M√≥dulo 01"
                const moduleNumber = parseInt(moduleNumberStr, 10); // Convert "01" to 1
                const moduleNumberEnPalabras = numberToWordsSpanish(moduleNumber);

                const textToSpeak = `Turno ${prefijoTurno} ${numeroTurnoEnPalabras}, dir√≠jase a la ventanilla ${moduleNumberEnPalabras}.`;
                console.log("Texto a anunciar:", textToSpeak);

                const payload = {
                    contents: [{
                        parts: [{ text: textToSpeak }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Charon" } // Voz en espa√±ol (Colombia)
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const apiKey = "AIzaSyCUBRXY-lDsx4Xm4s5MGzvvQF5wdjdLm3g"; // Canvas will inject the API key at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    // Extract sample rate from mimeType, e.g., "audio/L16;rate=16000"
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000; // Default to 16000 if not found

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData); // API returns signed PCM16 audio data.
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    const audio = new Audio(audioUrl);
                    audio.play().catch(e => console.error("Error al reproducir el audio TTS (posiblemente bloqueado por el navegador):", e));
                    audio.onended = () => URL.revokeObjectURL(audioUrl); // Clean up URL
                } else {
                    console.error("No se recibieron datos de audio v√°lidos de la API de TTS.");
                }

            } catch (error) {
                console.error("Error al anunciar el turno con TTS:", error);
            }
        }
        

        // Funci√≥n para actualizar el display del turno actual
        async function updateCurrentTurnDisplay(turn) {
            if (turn) {
                currentTurnNumberElement.textContent = `${turn.prefijo_turno}-${String(turn.numero_turno).padStart(3, '0')}`;
                currentTurnModuleElement.textContent = `Dir√≠jase a la Ventanilla ${turn.modulos.nombre_modulo.split(' ')[1]}`;

                // Reproducir sonido si es un nuevo turno llamado
                if (turn.id_turno !== lastCalledTurnId) {
                    await announceTurn(turn.prefijo_turno, turn.numero_turno, turn.modulos.nombre_modulo);
                    lastCalledTurnId = turn.id_turno;

                    // A√±adir animaci√≥n de pulso al display principal
                    currentTurnDisplayElement.classList.add('pulse-animation');
                    setTimeout(() => {
                        currentTurnDisplayElement.classList.remove('pulse-animation');
                    }, 1500); // Duraci√≥n de la animaci√≥n
                }
            } else {
                currentTurnNumberElement.textContent = '---';
                currentTurnModuleElement.textContent = 'Esperando nuevo turno...';
                lastCalledTurnId = null;
            }
        }

        // Funci√≥n para actualizar el historial de llamados
        function updateCallHistory(history) {
            callHistoryElement.innerHTML = ''; // Limpiar el historial actual
            if (history.length === 0) {
                callHistoryElement.innerHTML = '<div class="history-item text-gray-500"><span>Sin turnos previos</span></div>';
                return;
            }
            history.forEach(turn => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <span>${turn.prefijo_turno}-${String(turn.numero_turno).padStart(3, '0')}</span>
                    <span class="text-gray-400">M√≥dulo ${turn.modulos.nombre_modulo.split(' ')[1]}</span>
                `;
                callHistoryElement.appendChild(div);
            });
        }

        // Funci√≥n para actualizar el estado de los m√≥dulos
        async function updateModulesStatus(modules) {
            modulesStatusBodyElement.innerHTML = ''; // Limpiar la tabla actual
            if (modules.length === 0) {
                modulesStatusBodyElement.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-gray-500">No hay m√≥dulos registrados.</td>
                    </tr>
                `;
                return;
            }
            /*
            // Obtener todos los usuarios para mapear ID a nombre
            let allUsers = {};
            try {
                const { data: users, error: usersError } = await supabase
                    .from('usuarios')
                    .select('id_usuario, nombre_completo');
                if (usersError) throw usersError;
                users.forEach(user => {
                    allUsers[user.id_usuario] = user.nombre_completo;
                });
            } catch (error) {
                console.error("Error al cargar todos los usuarios para el estado de m√≥dulos:", error.message);
                // Continuar sin nombres de usuario si hay un error
            }*/

            modules.forEach(mod => {
                const tr = document.createElement('tr');
                let statusClass = '';
                let statusText = '';
                let currentTurnInfo = '';
                
                // Obtener el nombre del funcionario asignado (si existe)
        const funcionarioNombre = mod.usuarios && mod.usuarios.length > 0 
            ? mod.usuarios[0].nombre_completo 
            : 'Sin Asignar';
                // Filtrar turnos para mostrar solo el que est√° 'en atencion' por ese m√≥dulo
                const currentTurn = mod.turnos ? mod.turnos.find(t => t.estado === 'en atencion') : null;
                switch (mod.estado) {
                    case 'activo':
                        statusClass = 'status-available';
                        statusText = 'Disponible';
                        if (currentTurn) {
                            statusClass = 'status-attending';
                            statusText = 'Atendiendo';
                            currentTurnInfo = `Turno: ${currentTurn.prefijo_turno}-${String(currentTurn.numero_turno).padStart(3, '0')}`;
                        }
                        break;
                    case 'inactivo':
                        statusClass = 'status-inactive';
                        statusText = 'Inactivo';
                        break;
                    default:
                        statusClass = 'text-gray-400';
                        statusText = mod.estado; // Mostrar estado desconocido
                }

                tr.innerHTML = `
                    <td>${mod.nombre_modulo}</td>
                    <td>${funcionarioNombre}</td>
                    <td class="${statusClass}">${statusText} ${currentTurnInfo}</td>
                `;
                modulesStatusBodyElement.appendChild(tr);
            });
        }

        // --- Suscripciones en tiempo real a Supabase ---

        function setupRealtimeSubscriptions() {
            // Suscribirse a cambios en la tabla 'turnos'
            const turnosChannel = supabase.channel('turnos_channel');
            turnosChannel
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'turnos' },
                    async payload => {
                        console.log('Cambio en turnos recibido en visualizador!', payload);
                        await loadInitialData();
                    }
                )
                .subscribe();

            // Suscribirse a cambios en la tabla 'modulos'
            const modulosChannel = supabase.channel('modulos_channel');
            modulosChannel
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'modulos' },
                    async payload => {
                        console.log('Cambio en modulos recibido en visualizador!', payload);
                        await loadInitialData();
                    }
                )
                .subscribe();

            // Suscribirse a cambios en la tabla 'usuarios' (para nombres de funcionarios)
            const usuariosChannel = supabase.channel('usuarios_channel');
            usuariosChannel
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'usuarios' },
                    async payload => {
                        console.log('Cambio en usuarios recibido en visualizador!', payload);
                        await loadInitialData();
                    }
                )
                .subscribe();

            console.log("Suscripciones Realtime configuradas.");
        }


        // Funci√≥n para cargar los datos iniciales y mantener actualizados los displays
        async function loadInitialData() {
            try {
                // 1. Cargar el √∫ltimo turno llamado (estado 'en atencion')
                const { data: currentTurnData, error: currentTurnError } = await supabase
                    .from('turnos')
                    .select('*, modulos(nombre_modulo)')
                    .eq('estado', 'en atencion')
                    .order('hora_llamado', { ascending: false })
                    .limit(1);

                if (currentTurnError) throw currentTurnError;
                updateCurrentTurnDisplay(currentTurnData && currentTurnData.length > 0 ? currentTurnData[0] : null);

                // 2. Cargar el historial de los √∫ltimos 5 turnos llamados (estado 'atendido' o 'en atencion')
                const { data: historyData, error: historyError } = await supabase
                    .from('turnos')
                    .select('*, modulos(nombre_modulo)')
                    .or('estado.eq.atendido,estado.eq.en atencion')
                    .order('hora_llamado', { ascending: false })
                    .limit(5);

                if (historyError) throw historyError;
                updateCallHistory(historyData || []);

                // 3. Cargar el estado de todos los m√≥dulos, incluyendo el ID del funcionario asignado
                const { data: modulesData, error: modulesError } = await supabase
    .from('modulos')
    .select(`
        *,
        usuarios!usuarios_id_modulo_asignado_fkey(nombre_completo, id_usuario),
        turnos(id_turno, numero_turno, prefijo_turno, estado)
    `)
    .order('nombre_modulo', { ascending: true }); // Ordenar por nombre para consistencia

                if (modulesError) throw modulesError;

                // Filtrar turnos para mostrar solo el que est√° 'en atencion' por ese m√≥dulo
                const processedModulesData = modulesData.map(mod => ({
                    ...mod,
                    turnos: mod.turnos ? mod.turnos.filter(t => t.estado === 'en atencion') : []
                }));

                await updateModulesStatus(processedModulesData || []); // Usar await aqu√≠
            } catch (error) {
                console.error('Error al cargar datos iniciales para el visualizador:', error.message);
            }
        }

        // Cargar datos iniciales al cargar la p√°gina
        window.onload = () => {
            loadInitialData();
            // Retrasar la configuraci√≥n de las suscripciones en tiempo real
            setTimeout(setupRealtimeSubscriptions, 500); // Retraso de 500ms
        };

    </script>
</body>
</html>
